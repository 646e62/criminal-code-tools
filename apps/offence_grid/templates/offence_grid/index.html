{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<!-- Tom Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<!-- Tom Select JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<style>
.ts-wrapper {
    min-height: 42px;
}
.ts-control {
    min-height: 42px;
    padding: 8px !important;
}
/* Dark mode styles for Tom Select */
.dark .ts-control {
    background-color: #374151 !important;
    border-color: #4B5563 !important;
    color: #E5E7EB !important;
}
.dark .ts-dropdown {
    background-color: #374151 !important;
    border-color: #4B5563 !important;
    color: #E5E7EB !important;
}
.dark .ts-dropdown .active {
    background-color: #4B5563 !important;
    color: #F3F4F6 !important;
}
.dark .ts-dropdown .option:hover {
    background-color: #4B5563 !important;
}
.dark .ts-control input {
    color: #E5E7EB !important;
}
/* Monokai mode styles for Tom Select */
.monokai .ts-control {
    background-color: #272822 !important;
    border-color: #75715E !important;
    color: #F8F8F2 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.monokai .ts-dropdown {
    background-color: #272822 !important;
    border-color: #75715E !important;
    color: #F8F8F2 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.monokai .ts-dropdown .active {
    background-color: #3E3D32 !important;
    color: #F8F8F2 !important;
}
.monokai .ts-dropdown .option:hover {
    background-color: #3E3D32 !important;
}
.monokai .ts-control input {
    color: #F8F8F2 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.monokai .ts-wrapper.multi .ts-control > div {
    background-color: #3E3D32 !important;
    color: #66D9EF !important;
    border-color: #75715E !important;
    font-family: 'JetBrains Mono', monospace !important;
}

.footnote-ref {
    font-size: 0.75em;
    vertical-align: super;
    color: #4F46E5;
    text-decoration: none;
}

.footnote-ref:hover {
    text-decoration: underline;
}

.footnotes {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #E5E7EB;
}

.footnote-item {
    font-size: 0.875rem;
    color: #6B7280;
    margin-bottom: 0.5rem;
}

.footnote-backref {
    color: #4F46E5;
    text-decoration: none;
    margin-left: 0.5rem;
}

.footnote-backref:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white dark:bg-gray-800 monokai:bg-monokai-bg shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 monokai:text-keyword">Offence Analysis</h1>
            
            <!-- Search Section -->
            <div class="mt-6">
                <h2 class="text-xl font-medium text-gray-900 dark:text-gray-100 monokai:text-function">Search Offences</h2>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400 monokai:text-comment">
                    Select one or more offences to view their potential consequences and available sentencing options
                </p>
                
                <form method="get" class="mt-4">
                    <div class="max-w-xl">
                        <label for="offences" class="block text-sm font-medium text-gray-700 dark:text-gray-300 monokai:text-type">Select Offences</label>
                        <select name="offences" id="offences" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 monokai:border-monokai-gray focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md dark:bg-gray-700 monokai:bg-monokai-bg dark:text-gray-200 monokai:text-string">
                            {% for section, display in offences %}
                            <option value="{{ section }}" {% if section in selected_offences %}selected{% endif %}>
                                {{ display }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 monokai:bg-monokai-pink monokai:hover:bg-monokai-purple focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800 monokai:focus:ring-offset-monokai-bg">
                        Search
                    </button>
                </form>
                
                {% if results %}
                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 monokai:text-type">Analysis Results</h3>
                    <div class="mt-2 space-y-6">
                        {% for offence, result in results.items %}
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 monokai:bg-monokai-darkGray rounded-md">
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 monokai:text-keyword">{{ offence }} - {{ result.summary.description }}</h4>
                                </div>

                                <!-- Offence Summary -->
                                <div class="mt-12 pt-8">
                                    <h5 class="font-medium text-lg text-gray-700 dark:text-gray-300 monokai:text-variable">Offence Summary</h5>
                                    <div class="mt-4 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Mode:</span> {{ result.summary.mode }}
                                        </div>
                                        {% if result.summary.summary_maximum %}
                                        <div class="text-sm">
                                            <span class="font-medium">Summary Maximum:</span>
                                            {% if result.summary.summary_maximum.jail.amount == 255 and result.summary.summary_maximum.jail.unit == 'years' %}
                                                Life
                                            {% else %}
                                                {% if result.summary.summary_maximum.jail.amount %}{{ result.summary.summary_maximum.jail.amount }} {{ result.summary.summary_maximum.jail.unit }}{% endif %}
                                                {% if result.summary.summary_maximum.jail.amount and result.summary.summary_maximum.fine.amount %} or {% endif %}
                                                {% if result.summary.summary_maximum.fine.amount %}${{ result.summary.summary_maximum.fine.amount }}{% endif %}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% if result.summary.indictable_maximum %}
                                        <div class="text-sm">
                                            <span class="font-medium">Indictable Maximum:</span>
                                            {% if result.summary.indictable_maximum.jail.amount == 255 and result.summary.indictable_maximum.jail.unit == 'years' %}
                                                Life
                                            {% else %}
                                                {% if result.summary.indictable_maximum.jail.amount %}{{ result.summary.indictable_maximum.jail.amount }} {{ result.summary.indictable_maximum.jail.unit }}{% endif %}
                                                {% if result.summary.indictable_maximum.jail.amount and result.summary.indictable_maximum.fine.amount %} or {% endif %}
                                                {% if result.summary.indictable_maximum.fine.amount %}${{ result.summary.indictable_maximum.fine.amount }}{% endif %}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        <div class="text-sm">
                                            <span class="font-medium">Mandatory Minimum:</span>
                                            {% if result.summary.summary_minimum.jail.amount or result.summary.summary_minimum.fine.amount or result.summary.indictable_minimum.jail.amount or result.summary.indictable_minimum.fine.amount %}
                                            <span class="text-red-600 dark:text-red-400">Yes</span>
                                            <ul class="list-disc list-inside ml-4 mt-1">
                                                {% if result.summary.summary_minimum.jail.amount or result.summary.summary_minimum.fine.amount %}
                                                <li class="text-sm">Summary: 
                                                    {% if result.summary.summary_minimum.jail.amount %}
                                                        {% if result.summary.summary_minimum.jail.amount == 255 and result.summary.summary_minimum.jail.unit == 'years' %}Life{% else %}{{ result.summary.summary_minimum.jail.amount }} {{ result.summary.summary_minimum.jail.unit }}{% endif %}
                                                    {% endif %}
                                                    {% if result.summary.summary_minimum.fine.amount %}
                                                        {% if result.summary.summary_minimum.jail.amount %} or {% endif %}${{ result.summary.summary_minimum.fine.amount }}
                                                    {% endif %}
                                                </li>
                                                {% endif %}
                                                {% if result.summary.indictable_minimum.jail.amount or result.summary.indictable_minimum.fine.amount %}
                                                <li class="text-sm">Indictable: 
                                                    {% if result.summary.indictable_minimum.jail.amount %}
                                                        {% if result.summary.indictable_minimum.jail.amount == 255 and result.summary.indictable_minimum.jail.unit == 'years' %}Life{% else %}{{ result.summary.indictable_minimum.jail.amount }} {{ result.summary.indictable_minimum.jail.unit }}{% endif %}
                                                    {% endif %}
                                                    {% if result.summary.indictable_minimum.fine.amount %}
                                                        {% if result.summary.indictable_minimum.jail.amount %} or {% endif %}${{ result.summary.indictable_minimum.fine.amount }}
                                                    {% endif %}
                                                </li>
                                                {% endif %}
                                            </ul>
                                            {% else %}
                                            <span class="text-green-600 dark:text-green-400">No</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Procedure -->
                                <div class="mt-16 pt-8">
                                    <h5 class="font-medium text-lg text-gray-700 dark:text-gray-300 monokai:text-variable">Procedure</h5>
                                    <div class="mt-4 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Preliminary Inquiry:</span>
                                            {% if result.procedure.prelim_available.status.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.procedure.prelim_available.notes %}
                                            {% if result.procedure.prelim_footnote %}
                                            <a href="#footnote-{{ result.procedure.prelim_footnote.anchor }}" class="footnote-ref" id="ref-{{ result.procedure.prelim_footnote.anchor }}">[{{ result.procedure.prelim_footnote.number }}]</a>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Jury Trial:</span>
                                            {% if result.procedure.jury_trial_available.status.available %}
                                                {% if result.procedure.jury_trial_available.jury_required %}
                                                    <span class="text-yellow-600 dark:text-yellow-400">Required</span>
                                                {% else %}
                                                    <span class="text-green-600 dark:text-green-400">Available</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.procedure.jury_trial_available.notes %}
                                            {% if result.procedure.jury_footnote %}
                                            <a href="#footnote-{{ result.procedure.jury_footnote.anchor }}" class="footnote-ref" id="ref-{{ result.procedure.jury_footnote.anchor }}">[{{ result.procedure.jury_footnote.number }}]</a>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Bail -->
                                <div class="mt-16 pt-8">
                                    <h5 class="font-medium text-lg text-gray-700 dark:text-gray-300 monokai:text-variable">Bail</h5>
                                    <div class="mt-4 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Reverse Onus:</span>
                                            {% if result.bail.reverse_onus.status.available %}
                                                Yes [{{ result.bail.reverse_onus_footnote|add:1 }}]
                                            {% else %}
                                                No
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Section 469:</span>
                                            {% if result.bail.section_469.status.available %}
                                                Yes [{{ result.bail.section_469_footnote|add:1 }}]
                                            {% else %}
                                                No
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Mandatory Weapons Prohibition:</span>
                                            {% if result.bail.mandatory_weapons_prohibition.status.available %}
                                                Yes [{{ result.bail.mandatory_weapons_prohibition_footnote|add:1 }}]
                                            {% else %}
                                                No
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Collateral Consequences -->
                                <div class="mt-16 pt-8">
                                    <h5 class="font-medium text-lg text-gray-700 dark:text-gray-300 monokai:text-variable">Collateral Consequences</h5>
                                    <div class="mt-4 space-y-2">
                                        {% for immigration_result in result.immigration %}
                                        <div class="text-sm">
                                            <span class="font-medium">Immigration/Admissibility:</span>
                                            {% if immigration_result.notes == "serious criminality" and immigration_result.status.notes == "both" %}
                                            <span class="text-red-600 dark:text-red-400">Permanent residents and foreign nationals</span>
                                            {% elif immigration_result.notes == "criminality" %}
                                            <span class="text-red-600 dark:text-red-400">Foreign nationals</span>
                                            {% elif immigration_result.notes == "none" %}
                                            <span class="text-green-600 dark:text-green-400">None</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">{{ immigration_result.notes|title }}</span>
                                            {% endif %}
                                            {% if immigration_result.sections and immigration_result.footnote %}
                                            <a href="#footnote-{{ immigration_result.footnote.anchor }}" class="footnote-ref" id="ref-{{ immigration_result.footnote.anchor }}">[{{ immigration_result.footnote.number }}]</a>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Sentencing Options -->
                                <div class="mt-16 pt-8">
                                    <h5 class="font-medium text-lg text-gray-700 dark:text-gray-300 monokai:text-variable">Sentencing Options</h5>
                                    <div class="mt-4 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Discharge:</span>
                                            {% if result.sentencing_options.discharge.status.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.discharge.footnote %}
                                             <a href="#footnote-{{ result.sentencing_options.discharge.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.sentencing_options.discharge.footnote.anchor }}">[{{ result.sentencing_options.discharge.footnote.number }}]</a>
                                             {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">CSO:</span>
                                            {% if result.sentencing_options.cso.status.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.cso.footnote %}
                                             <a href="#footnote-{{ result.sentencing_options.cso.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.sentencing_options.cso.footnote.anchor }}">[{{ result.sentencing_options.cso.footnote.number }}]</a>
                                             {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">Intermittent Sentence:</span>
                                            {% if result.sentencing_options.intermittent.status.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.intermittent.footnote %}
                                             <a href="#footnote-{{ result.sentencing_options.intermittent.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.sentencing_options.intermittent.footnote.anchor }}">[{{ result.sentencing_options.intermittent.footnote.number }}]</a>
                                             {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">Suspended Sentence:</span>
                                            {% if result.sentencing_options.suspended.status.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.suspended.footnote %}
                                             <a href="#footnote-{{ result.sentencing_options.suspended.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.sentencing_options.suspended.footnote.anchor }}">[{{ result.sentencing_options.suspended.footnote.number }}]</a>
                                             {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Ancillary Orders -->
                                <div class="mt-16 pt-8">
                                    <h5 class="font-medium text-lg text-gray-700 dark:text-gray-300 monokai:text-variable">Ancillary Orders</h5>
                                    <div class="mt-4 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">DNA Order:</span>
                                            {% if result.ancillary_orders.dna.notes == "primary designated offence" %}
                                            <span class="text-red-600 dark:text-red-400">Mandatory</span>
                                            {% elif result.ancillary_orders.dna.notes == "secondary designated offence" %}
                                            <span class="text-yellow-600 dark:text-yellow-400">Discretionary</span>
                                            {% else %}
                                            <span class="text-green-600 dark:text-green-400">Not Available</span>
                                            {% endif %}
                                            {% if result.ancillary_orders.dna.footnote %}
                                             <a href="#footnote-{{ result.ancillary_orders.dna.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.ancillary_orders.dna.footnote.anchor }}">[{{ result.ancillary_orders.dna.footnote.number }}]</a>
                                             {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">SOIRA Registration:</span>
                                            {% if result.ancillary_orders.soira.0.notes == "primary designated offence" %}
                                            <span class="text-red-600 dark:text-red-400">Primary Designated Offence</span>
                                            {% elif result.ancillary_orders.soira.0.notes == "secondary designated offence" %}
                                            <span class="text-yellow-600 dark:text-yellow-400">Secondary Designated Offence</span>
                                            {% else %}
                                            <span class="text-green-600 dark:text-green-400">Not Available</span>
                                            {% endif %}
                                            {% if result.ancillary_orders.soira.0.footnote %}
                                             <a href="#footnote-{{ result.ancillary_orders.soira.0.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.ancillary_orders.soira.0.footnote.anchor }}">[{{ result.ancillary_orders.soira.0.footnote.number }}]</a>
                                             {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">Weapons Prohibition:</span>
                                            {% if result.ancillary_orders.weapons.status.available %}
                                            <span class="text-green-600 dark:text-green-400">Required</span>
                                            {% else %}
                                            <span class="text-gray-500">Not Required</span>
                                            {% endif %}
                                            {% if result.ancillary_orders.weapons.footnote %}
                                             <a href="#footnote-{{ result.ancillary_orders.weapons.footnote.anchor }}" class="footnote-ref" id="ref-{{ result.ancillary_orders.weapons.footnote.anchor }}">[{{ result.ancillary_orders.weapons.footnote.number }}]</a>
                                             {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Footnotes -->
                                <div class="footnotes">
                                    {% for footnote in result.footnotes %}
                                    <div class="footnote-item" id="footnote-{{ footnote.anchor }}">
                                        [{{ footnote.number }}] {{ footnote.text }}
                                        <a href="#ref-{{ footnote.anchor }}" class="footnote-backref">↩</a>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    new TomSelect('#offences', {
        plugins: ['remove_button'],
        create: false,
        sortField: {
            field: 'text',
            direction: 'asc'
        },
        placeholder: 'Search for offences...',
        maxItems: null,
        searchField: ['text'],
        render: {
            option: function(data, escape) {
                return '<div class="py-2 px-3">' + escape(data.text) + '</div>';
            },
            item: function(data, escape) {
                return '<div class="py-1 px-2">' + escape(data.text) + '</div>';
            }
        }
    });
});
</script>
{% endblock %}
