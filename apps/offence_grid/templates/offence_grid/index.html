{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<!-- Tom Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<!-- Tom Select JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<style>
.ts-wrapper {
    min-height: 42px;
}
.ts-control {
    min-height: 42px;
    padding: 8px !important;
}
/* Dark mode styles for Tom Select */
.dark .ts-control {
    background-color: #374151 !important;
    border-color: #4B5563 !important;
    color: #E5E7EB !important;
}
.dark .ts-dropdown {
    background-color: #374151 !important;
    border-color: #4B5563 !important;
    color: #E5E7EB !important;
}
.dark .ts-dropdown .active {
    background-color: #4B5563 !important;
    color: #F3F4F6 !important;
}
.dark .ts-dropdown .option:hover {
    background-color: #4B5563 !important;
}
.dark .ts-control input {
    color: #E5E7EB !important;
}
/* Monokai mode styles for Tom Select */
.monokai .ts-control {
    background-color: #272822 !important;
    border-color: #75715E !important;
    color: #F8F8F2 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.monokai .ts-dropdown {
    background-color: #272822 !important;
    border-color: #75715E !important;
    color: #F8F8F2 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.monokai .ts-dropdown .active {
    background-color: #3E3D32 !important;
    color: #F8F8F2 !important;
}
.monokai .ts-dropdown .option:hover {
    background-color: #3E3D32 !important;
}
.monokai .ts-control input {
    color: #F8F8F2 !important;
    font-family: 'JetBrains Mono', monospace !important;
}
.monokai .ts-wrapper.multi .ts-control > div {
    background-color: #3E3D32 !important;
    color: #66D9EF !important;
    border-color: #75715E !important;
    font-family: 'JetBrains Mono', monospace !important;
}

.footnote-ref {
    font-size: 0.75em;
    vertical-align: super;
    color: #4F46E5;
    text-decoration: none;
}

.footnote-ref:hover {
    text-decoration: underline;
}

.footnotes {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #E5E7EB;
}

.footnote-item {
    font-size: 0.875rem;
    color: #6B7280;
    margin-bottom: 0.5rem;
}

.footnote-backref {
    color: #4F46E5;
    text-decoration: none;
    margin-left: 0.5rem;
}

.footnote-backref:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white dark:bg-gray-800 monokai:bg-monokai-bg shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 monokai:text-keyword">Offence Analysis</h1>
            
            <!-- Search Section -->
            <div class="mt-6">
                <h2 class="text-xl font-medium text-gray-900 dark:text-gray-100 monokai:text-function">Search Offences</h2>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400 monokai:text-comment">
                    Select one or more offences to view their potential consequences and available sentencing options
                </p>
                
                <form method="get" class="mt-4">
                    <div class="max-w-xl">
                        <label for="offences" class="block text-sm font-medium text-gray-700 dark:text-gray-300 monokai:text-type">Select Offences</label>
                        <select name="offences" id="offences" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 monokai:border-monokai-gray focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md dark:bg-gray-700 monokai:bg-monokai-bg dark:text-gray-200 monokai:text-string">
                            {% for section, display in offences %}
                            <option value="{{ section }}" {% if section in selected_offences %}selected{% endif %}>
                                {{ display }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 monokai:bg-monokai-pink monokai:hover:bg-monokai-purple focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800 monokai:focus:ring-offset-monokai-bg">
                        Search
                    </button>
                </form>
                
                {% if results %}
                <div class="mt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 monokai:text-type">Analysis Results</h3>
                    <div class="mt-2 space-y-6">
                        {% for offence, result in results.items %}
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 monokai:bg-monokai-darkGray rounded-md">
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 monokai:text-keyword">{{ offence }}</h4>
                                </div>

                                <!-- Offence Summary -->
                                <div class="mt-4">
                                    <h5 class="font-medium text-gray-700 dark:text-gray-300 monokai:text-variable">Offence Summary</h5>
                                    <div class="mt-2 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Mode:</span> {{ result.summary.mode }}
                                        </div>
                                        {% if 'summary_maximum' in result.summary %}
                                        <div class="text-sm">
                                            <span class="font-medium">Summary Maximum:</span>
                                            {% if result.summary.summary_maximum.jail.amount == 255 and result.summary.summary_maximum.jail.unit == 'years' %}
                                                Life
                                            {% else %}
                                                {% if result.summary.summary_maximum.jail.amount %}{{ result.summary.summary_maximum.jail.amount }} {{ result.summary.summary_maximum.jail.unit }}
                                                {% elif result.summary.summary_maximum.fine.amount %}${{ result.summary.summary_maximum.fine.amount }}
                                                {% else %}None{% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Summary Minimum:</span>
                                            {% if result.summary.summary_minimum.jail.amount or result.summary.summary_minimum.fine.amount %}
                                                {% if result.summary.summary_minimum.jail.amount == 255 and result.summary.summary_minimum.jail.unit == 'years' %}
                                                    Life
                                                {% else %}
                                                    {% if result.summary.summary_minimum.jail.amount %}{{ result.summary.summary_minimum.jail.amount }} {{ result.summary.summary_minimum.jail.unit }}{% endif %}
                                                    {% if result.summary.summary_minimum.fine.amount %}{% if result.summary.summary_minimum.jail.amount %} and {% endif %}${{ result.summary.summary_minimum.fine.amount }}{% endif %}
                                                {% endif %}
                                            {% else %}
                                                None
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% if 'indictable_maximum' in result.summary %}
                                        <div class="text-sm">
                                            <span class="font-medium">Indictable Maximum:</span>
                                            {% if result.summary.indictable_maximum.jail.amount == 255 and result.summary.indictable_maximum.jail.unit == 'years' %}
                                                Life
                                            {% else %}
                                                {% if result.summary.indictable_maximum.jail.amount %}{{ result.summary.indictable_maximum.jail.amount }} {{ result.summary.indictable_maximum.jail.unit }}{% endif %}
                                                {% if result.summary.indictable_maximum.fine.amount %}{% if result.summary.indictable_maximum.jail.amount %} and {% endif %}${{ result.summary.indictable_maximum.fine.amount }}{% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Indictable Minimum:</span>
                                            {% if result.summary.indictable_minimum.jail.amount or result.summary.indictable_minimum.fine.amount %}
                                                {% if result.summary.indictable_minimum.jail.amount == 255 and result.summary.indictable_minimum.jail.unit == 'years' %}
                                                    Life
                                                {% else %}
                                                    {% if result.summary.indictable_minimum.jail.amount %}{{ result.summary.indictable_minimum.jail.amount }} {{ result.summary.indictable_minimum.jail.unit }}{% endif %}
                                                    {% if result.summary.indictable_minimum.fine.amount %}{% if result.summary.indictable_minimum.jail.amount %} and {% endif %}${{ result.summary.indictable_minimum.fine.amount }}{% endif %}
                                                {% endif %}
                                            {% else %}
                                                None
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Bail -->
                                <div class="mt-4">
                                    <h5 class="font-medium text-gray-700 dark:text-gray-300 monokai:text-variable">Bail</h5>
                                    <div class="mt-2 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Reverse Onus:</span>
                                            {% if result.bail.reverse_onus.status.available %}
                                                Yes [{{ forloop.counter|add:8 }}]
                                            {% else %}
                                                No
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Section 469:</span>
                                            {% if result.bail.section_469.status.available %}
                                                Yes [{{ forloop.counter|add:9 }}]
                                            {% else %}
                                                No
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">Mandatory Weapons Prohibition:</span>
                                            {% if result.bail.mandatory_weapons_prohibition.status.available %}
                                                Yes [{{ forloop.counter|add:10 }}]
                                            {% else %}
                                                No
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Collateral Consequences -->
                                <div class="mt-4">
                                    <h5 class="font-medium text-gray-700 dark:text-gray-300 monokai:text-variable">Collateral Consequences</h5>
                                    <div class="mt-2 space-y-2">
                                        {% for immigration_result in result.immigration %}
                                        <div class="text-sm">
                                            <span class="font-medium">Immigration/Admissibility:</span>
                                            {% if immigration_result.notes == "serious criminality" and immigration_result.status.notes == "both" %}
                                            <span class="text-red-600 dark:text-red-400">Permanent residents and foreign nationals</span>
                                            {% elif immigration_result.notes == "criminality" %}
                                            <span class="text-red-600 dark:text-red-400">Foreign nationals</span>
                                            {% elif immigration_result.notes == "none" %}
                                            <span class="text-green-600 dark:text-green-400">None</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">{{ immigration_result.notes|title }}</span>
                                            {% endif %}
                                            {% if immigration_result.sections %}
                                            <a href="#footnote-{{ forloop.parentloop.counter }}-imm-{{ forloop.counter }}" class="footnote-ref" id="ref-{{ forloop.parentloop.counter }}-imm-{{ forloop.counter }}">[{{ forloop.counter }}]</a>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Sentencing Options -->
                                <div class="mt-4">
                                    <h5 class="font-medium text-gray-700 dark:text-gray-300 monokai:text-variable">Sentencing Options</h5>
                                    <div class="mt-2 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">Discharge:</span>
                                            {% if result.sentencing_options.discharge.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.discharge.notes %}
                                            {% with counter=result.immigration|length|add:1 %}
                                            <a href="#footnote-{{ forloop.counter }}-dis" class="footnote-ref" id="ref-{{ forloop.counter }}-dis">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">CSO:</span>
                                            {% if result.sentencing_options.cso.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.cso.notes %}
                                            {% with counter=result.immigration|length|add:2 %}
                                            <a href="#footnote-{{ forloop.counter }}-cso" class="footnote-ref" id="ref-{{ forloop.counter }}-cso">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">Intermittent Sentence:</span>
                                            {% if result.sentencing_options.intermittent.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.intermittent.notes %}
                                            {% with counter=result.immigration|length|add:3 %}
                                            <a href="#footnote-{{ forloop.counter }}-int" class="footnote-ref" id="ref-{{ forloop.counter }}-int">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">Suspended Sentence:</span>
                                            {% if result.sentencing_options.suspended.available %}
                                            <span class="text-green-600 dark:text-green-400">Available</span>
                                            {% else %}
                                            <span class="text-red-600 dark:text-red-400">Not Available</span>
                                            {% endif %}
                                            {% if result.sentencing_options.suspended.notes %}
                                            {% with counter=result.immigration|length|add:4 %}
                                            <a href="#footnote-{{ forloop.counter }}-sus" class="footnote-ref" id="ref-{{ forloop.counter }}-sus">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Ancillary Orders -->
                                <div class="mt-4">
                                    <h5 class="font-medium text-gray-700 dark:text-gray-300 monokai:text-variable">Ancillary Orders</h5>
                                    <div class="mt-2 space-y-2">
                                        <div class="text-sm">
                                            <span class="font-medium">DNA Order:</span>
                                            {% if result.ancillary_orders.dna.notes == "primary designated offence" %}
                                            <span class="text-red-600 dark:text-red-400">Mandatory</span>
                                            {% elif result.ancillary_orders.dna.notes == "secondary designated offence" %}
                                            <span class="text-yellow-600 dark:text-yellow-400">Discretionary</span>
                                            {% else %}
                                            <span class="text-green-600 dark:text-green-400">Not Available</span>
                                            {% endif %}
                                            {% if result.ancillary_orders.dna.notes %}
                                            {% with counter=result.immigration|length|add:5 %}
                                            <a href="#footnote-{{ forloop.counter }}-dna" class="footnote-ref" id="ref-{{ forloop.counter }}-dna">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">SOIRA Registration:</span>
                                            {% if result.ancillary_orders.soira.0.available %}
                                            <span class="text-green-600 dark:text-green-400">Required</span>
                                            {% if result.ancillary_orders.soira.0.duration %}
                                            ({{ result.ancillary_orders.soira.0.duration.amount }} {{ result.ancillary_orders.soira.0.duration.unit }})
                                            {% endif %}
                                            {% else %}
                                            <span class="text-gray-500">Not Required</span>
                                            {% endif %}
                                            {% if result.ancillary_orders.soira.0.notes %}
                                            {% with counter=result.immigration|length|add:6 %}
                                            <a href="#footnote-{{ forloop.counter }}-soira" class="footnote-ref" id="ref-{{ forloop.counter }}-soira">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>

                                        <div class="text-sm">
                                            <span class="font-medium">Weapons Prohibition:</span>
                                            {% if result.ancillary_orders.weapons.available %}
                                            <span class="text-green-600 dark:text-green-400">Required</span>
                                            {% else %}
                                            <span class="text-gray-500">Not Required</span>
                                            {% endif %}
                                            {% if result.ancillary_orders.weapons.notes %}
                                            {% with counter=result.immigration|length|add:7 %}
                                            <a href="#footnote-{{ forloop.counter }}-wpn" class="footnote-ref" id="ref-{{ forloop.counter }}-wpn">[{{ counter }}]</a>
                                            {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Footnotes -->
                                <div class="footnotes">
                                    <!-- Immigration footnotes -->
                                    {% for immigration_result in result.immigration %}
                                        {% if immigration_result.sections %}
                                        <div class="footnote-item" id="footnote-{{ forloop.parentloop.counter }}-imm-{{ forloop.counter }}">
                                            [{{ forloop.counter }}] Relevant sections: {{ immigration_result.sections|join:", " }}
                                            <a href="#ref-{{ forloop.parentloop.counter }}-imm-{{ forloop.counter }}" class="footnote-backref">↩</a>
                                        </div>
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Sentencing Options footnotes -->
                                    {% if result.sentencing_options.discharge.notes %}
                                    {% with counter=result.immigration|length|add:1 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-dis">
                                        [{{ counter }}] {{ result.sentencing_options.discharge.notes }}
                                        <a href="#ref-{{ forloop.counter }}-dis" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    {% if result.sentencing_options.cso %}
                                    {% with counter=result.immigration|length|add:2 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-cso">
                                        [{{ counter }}] {{ result.sentencing_options.cso }}
                                        <a href="#ref-{{ forloop.counter }}-cso" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    {% if result.sentencing_options.intermittent.notes %}
                                    {% with counter=result.immigration|length|add:3 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-int">
                                        [{{ counter }}] {{ result.sentencing_options.intermittent.notes }}
                                        <a href="#ref-{{ forloop.counter }}-int" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    {% if result.sentencing_options.suspended.notes %}
                                    {% with counter=result.immigration|length|add:4 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-sus">
                                        [{{ counter }}] {{ result.sentencing_options.suspended.notes }}
                                        <a href="#ref-{{ forloop.counter }}-sus" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    <!-- Ancillary Orders footnotes -->
                                    {% if result.ancillary_orders.dna.notes %}
                                    {% with counter=result.immigration|length|add:5 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-dna">
                                        [{{ counter }}] {{ result.ancillary_orders.dna.notes }}
                                        {% if result.ancillary_orders.dna.sections %}
                                        ({{ result.ancillary_orders.dna.sections|join:", " }})
                                        {% endif %}
                                        <a href="#ref-{{ forloop.counter }}-dna" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    {% if result.ancillary_orders.soira.0.notes %}
                                    {% with counter=result.immigration|length|add:6 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-soira">
                                        [{{ counter }}] {{ result.ancillary_orders.soira.0.notes }}
                                        {% if result.ancillary_orders.soira.0.sections %}
                                        ({{ result.ancillary_orders.soira.0.sections|join:", " }})
                                        {% endif %}
                                        <a href="#ref-{{ forloop.counter }}-soira" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    {% if result.ancillary_orders.weapons.notes %}
                                    {% with counter=result.immigration|length|add:7 %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-wpn">
                                        [{{ counter }}] {{ result.ancillary_orders.weapons.notes }}
                                        <a href="#ref-{{ forloop.counter }}-wpn" class="footnote-backref">↩</a>
                                    </div>
                                    {% endwith %}
                                    {% endif %}

                                    {% if result.bail.reverse_onus.status.available %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-ro">
                                        [{{ result.immigration|length|add:8 }}] {{ result.bail.reverse_onus.notes }}
                                        <a href="#ref-{{ forloop.counter }}-ro" class="footnote-backref">↩</a>
                                    </div>
                                    {% endif %}

                                    {% if result.bail.section_469.status.available %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-469">
                                        [{{ result.immigration|length|add:9 }}] {{ result.bail.section_469.notes }}
                                        <a href="#ref-{{ forloop.counter }}-469" class="footnote-backref">↩</a>
                                    </div>
                                    {% endif %}

                                    {% if result.bail.mandatory_weapons_prohibition.status.available %}
                                    <div class="footnote-item" id="footnote-{{ forloop.counter }}-mwp">
                                        [{{ result.immigration|length|add:10 }}] {{ result.bail.mandatory_weapons_prohibition.notes }}
                                        <a href="#ref-{{ forloop.counter }}-mwp" class="footnote-backref">↩</a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    new TomSelect('#offences', {
        plugins: ['remove_button'],
        create: false,
        sortField: {
            field: 'text',
            direction: 'asc'
        },
        placeholder: 'Search for offences...',
        maxItems: null,
        searchField: ['text'],
        render: {
            option: function(data, escape) {
                return '<div class="py-2 px-3">' + escape(data.text) + '</div>';
            },
            item: function(data, escape) {
                return '<div class="py-1 px-2">' + escape(data.text) + '</div>';
            }
        }
    });
});
</script>
{% endblock %}
